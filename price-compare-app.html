<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="PriceCompare">
  <meta name="description" content="Compare grocery prices between Coles and Foodland">
  <title>PriceCompare - Grocery Price Comparison</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
      overscroll-behavior: none;
    }
    
    #root {
      width: 100%;
      height: 100%;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { 
      ShoppingCart, Search, Plus, Home, User, ChevronRight, Tag, 
      TrendingDown, Clock, Database, RefreshCw, CheckCircle, 
      AlertCircle, Filter, Heart, Star 
    } = lucide;




function NavBar({ active, onNavigate, basketCount = 0 }) {
  const items = [
    { id: 'home', icon: Home, label: 'Home' },
    { id: 'search', icon: Search, label: 'Search' },
    { id: 'basket', icon: ShoppingCart, label: 'Baskets', badge: basketCount },
    { id: 'settings', icon: User, label: 'Settings' }
  ];

  return (
    <div className="border-t-2 border-gray-200 p-2 bg-white">
      <div className="flex justify-around">
        {items.map(item => (
          <button
            key={item.id}
            onClick={() => onNavigate(item.id)}
            className={`flex flex-col items-center gap-1 p-2 relative ${
              active === item.id ? 'text-blue-600' : 'text-gray-400'
            }`}
          >
            <item.icon size={22} />
            {item.badge > 0 && (
              <span className="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                {item.badge}
              </span>
            )}
            <span className="text-xs">{item.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
}

function HomeScreen({ onNavigate, onViewProduct, products, basketCount, baskets = [], onSelectBasket }) {
  const featuredProducts = products.slice(0, 2);

  return (
    <div className="flex flex-col h-full">
      <div className="bg-blue-600 text-white p-4">
        <h1 className="text-2xl font-bold">PriceCompare</h1>
        <p className="text-sm text-blue-100">Save money on your shopping</p>
      </div>

      <div className="p-4 flex-1 overflow-auto">
        <div className="mb-6">
          <button 
            onClick={() => onNavigate('search')}
            className="w-full bg-gray-100 border-2 border-gray-300 rounded-lg p-4 flex items-center gap-3 text-left"
          >
            <Search className="text-gray-400" size={20} />
            <span className="text-gray-500">Search products...</span>
          </button>
        </div>

        <div className="mb-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="font-semibold text-lg">My Baskets</h2>
            <span className="text-sm text-gray-500">{baskets.filter(b => b.items.length > 0).length} active</span>
          </div>
          
          <div className="space-y-3">
            {baskets.map((basket) => {
              const itemCount = basket.items.length;
              const totalItems = basket.items.reduce((sum, item) => sum + item.quantity, 0);
              const colesTotal = basket.items.reduce((sum, item) => sum + (item.colesPrice * item.quantity), 0);
              const foodlandTotal = basket.items.reduce((sum, item) => sum + (item.foodlandPrice * item.quantity), 0);
              const lowestTotal = Math.min(colesTotal, foodlandTotal);
              const cheaperStore = colesTotal < foodlandTotal ? 'Coles' : 'Foodland';
              
              return (
                <div
                  key={basket.id}
                  onClick={() => {
                    onSelectBasket(basket.id);
                    onNavigate('basket');
                  }}
                  className="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 relative"
                >
                  {basket.isFavorite && (
                    <button className="absolute top-3 right-3">
                      <Heart size={20} className="text-red-500 fill-red-500" />
                    </button>
                  )}
                  <div className="flex justify-between items-start mb-2 pr-8">
                    <h3 className="font-medium">{basket.name}</h3>
                    {itemCount > 0 && (
                      <span className="text-sm text-gray-500">{totalItems} item{totalItems !== 1 ? 's' : ''}</span>
                    )}
                  </div>
                  {itemCount === 0 ? (
                    <p className="text-sm text-gray-400">Empty basket</p>
                  ) : (
                    <div className="flex items-center gap-2">
                      <TrendingDown size={16} className="text-green-600" />
                      <span className="text-sm text-gray-600">Best at {cheaperStore} - ${lowestTotal.toFixed(2)}</span>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>

        <div className="mb-6">
          <h2 className="font-semibold text-lg mb-3">Popular Deals</h2>
          <div className="space-y-2">
            <div className="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-3">
              <Tag size={18} className="text-green-600" />
              <div className="flex-1">
                <p className="text-sm font-medium">Coles - Fresh Produce Special</p>
                <p className="text-xs text-gray-500">Ends in 3 days</p>
              </div>
            </div>
          </div>
        </div>

        <div>
          <h2 className="font-semibold text-lg mb-3">Popular Products</h2>
          <div className="space-y-3">
            {featuredProducts.map((product, i) => (
              <div 
                key={i}
                onClick={() => onViewProduct(product)}
                className="border-2 border-gray-200 rounded-lg p-3 cursor-pointer hover:border-blue-400"
              >
                <div className="flex gap-3">
                  <div className="w-14 h-14 bg-gray-200 rounded flex items-center justify-center">
                    <span className="text-2xl">{product.emoji}</span>
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <h3 className="font-medium text-sm">Coles {product.name}</h3>
                      <Star size={14} className="text-yellow-500 fill-yellow-500" />
                    </div>
                    <p className="text-xs text-gray-500 mb-1">{product.size}</p>
                    <span className="text-green-600 font-semibold text-sm">${product.colesPrice.toFixed(2)}</span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      <NavBar active="home" onNavigate={onNavigate} basketCount={basketCount} />
    </div>
  );
}

function SearchScreen({ onNavigate, products, isScraperRunning, lastUpdated, onRefreshPrices, onViewProduct, searchQuery, setSearchQuery, onAddToBasket, basketCount }) {
  const [showFilters, setShowFilters] = useState(false);
  const [selectedStores, setSelectedStores] = useState(['Coles', 'Foodland']);
  const [selectedCategories, setSelectedCategories] = useState([]);
  const [sortBy, setSortBy] = useState('name'); // 'name', 'price-low', 'price-high'

  const formatTime = (date) => {
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)} mins ago`;
    return `${Math.floor(diff / 3600)} hours ago`;
  };

  // Categorize products
  const categorizeProduct = (name) => {
    const n = name.toLowerCase();
    if (n.includes('apple') || n.includes('banana') || n.includes('orange') || n.includes('grape') || 
        n.includes('strawberr') || n.includes('watermelon') || n.includes('kiwi') || n.includes('nectarine') ||
        n.includes('rockmelon') || n.includes('raspberr') || n.includes('pineapple') || n.includes('avocado')) {
      return 'Fruit';
    }
    if (n.includes('lettuce') || n.includes('spinach') || n.includes('salad')) {
      return 'Salad & Greens';
    }
    if (n.includes('carrot') || n.includes('broccoli') || n.includes('capsicum') || n.includes('cucumber') ||
        n.includes('zucchini') || n.includes('pumpkin') || n.includes('mushroom') || n.includes('cauliflower') ||
        n.includes('celery')) {
      return 'Vegetables';
    }
    return 'Other';
  };

  // Filter by search query
  let filteredProducts = products.filter(product => 
    product.name.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // Apply category filter
  if (selectedCategories.length > 0) {
    filteredProducts = filteredProducts.filter(p => 
      selectedCategories.includes(categorizeProduct(p.name))
    );
  }

  // Apply store filter and add store data
  const productsWithStores = filteredProducts.map(product => {
    const allStores = [
      { name: 'Coles', price: product.colesPrice, badge: product.colesPrice < product.foodlandPrice ? 'Lowest' : null },
      { name: 'Foodland', price: product.foodlandPrice, badge: product.foodlandPrice < product.colesPrice ? 'Lowest' : null }
    ];
    
    const availableStores = allStores.filter(s => selectedStores.includes(s.name)).sort((a, b) => a.price - b.price);
    
    // If no stores available, skip this product
    if (availableStores.length === 0) {
      return null;
    }
    
    return {
      ...product,
      stores: availableStores,
      lowestPrice: Math.min(...availableStores.map(s => s.price)),
      category: categorizeProduct(product.name)
    };
  }).filter(p => p !== null); // Remove null entries

  // Sort products
  const sortedProducts = [...productsWithStores].sort((a, b) => {
    if (sortBy === 'name') {
      return a.name.localeCompare(b.name);
    } else if (sortBy === 'price-low') {
      return a.lowestPrice - b.lowestPrice;
    } else if (sortBy === 'price-high') {
      return b.lowestPrice - a.lowestPrice;
    }
    return 0;
  });

  const toggleStore = (store) => {
    setSelectedStores(prev => {
      // Prevent unselecting all stores - must have at least one
      if (prev.includes(store) && prev.length === 1) {
        return prev; // Don't allow removing the last store
      }
      return prev.includes(store) ? prev.filter(s => s !== store) : [...prev, store];
    });
  };

  const toggleCategory = (category) => {
    setSelectedCategories(prev => 
      prev.includes(category) ? prev.filter(c => c !== category) : [...prev, category]
    );
  };

  const clearFilters = () => {
    setSelectedStores(['Coles', 'Foodland']);
    setSelectedCategories([]);
    setSortBy('name');
  };

  const activeFilterCount = (selectedStores.length < 2 ? 1 : 0) + selectedCategories.length + (sortBy !== 'name' ? 1 : 0);

  return (
    <div className="flex flex-col h-full">
      <div className="bg-blue-600 text-white p-4">
        <div className="flex items-center gap-3 mb-3">
          <button onClick={() => onNavigate('home')} className="text-white">Back</button>
          <input 
            type="text" 
            placeholder="Search products..."
            className="flex-1 p-2 rounded text-gray-900"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>
        
        <button 
          onClick={() => setShowFilters(!showFilters)}
          className="w-full bg-blue-700 hover:bg-blue-800 py-2 rounded flex items-center justify-center gap-2 relative"
        >
          <Filter size={18} />
          <span>Filters & Sort</span>
          {activeFilterCount > 0 && (
            <span className="absolute right-3 top-1/2 -translate-y-1/2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
              {activeFilterCount}
            </span>
          )}
        </button>
      </div>

      {showFilters && (
        <div className="bg-white border-t-2 border-gray-200 p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="font-semibold">Filters & Sort</h3>
            <button onClick={clearFilters} className="text-blue-600 text-sm font-medium">
              Clear All
            </button>
          </div>

          {/* Store Filter */}
          <div className="mb-4">
            <p className="text-sm font-medium text-gray-700 mb-2">Stores</p>
            <div className="flex gap-2">
              {['Coles', 'Foodland'].map(store => (
                <button
                  key={store}
                  onClick={() => toggleStore(store)}
                  className={`flex-1 py-2 px-3 rounded border-2 text-sm font-medium ${
                    selectedStores.includes(store)
                      ? 'border-blue-600 bg-blue-50 text-blue-600'
                      : 'border-gray-300 bg-white text-gray-600'
                  }`}
                >
                  {store}
                </button>
              ))}
            </div>
          </div>

          {/* Category Filter */}
          <div className="mb-4">
            <p className="text-sm font-medium text-gray-700 mb-2">Categories</p>
            <div className="flex flex-wrap gap-2">
              {['Fruit', 'Vegetables', 'Salad & Greens', 'Other'].map(category => (
                <button
                  key={category}
                  onClick={() => toggleCategory(category)}
                  className={`py-1 px-3 rounded-full border-2 text-xs font-medium ${
                    selectedCategories.includes(category)
                      ? 'border-green-600 bg-green-50 text-green-600'
                      : 'border-gray-300 bg-white text-gray-600'
                  }`}
                >
                  {category}
                </button>
              ))}
            </div>
          </div>

          {/* Sort */}
          <div className="mb-2">
            <p className="text-sm font-medium text-gray-700 mb-2">Sort By</p>
            <div className="flex gap-2">
              {[
                { id: 'name', label: 'Name (A-Z)' },
                { id: 'price-low', label: 'Price: Low to High' },
                { id: 'price-high', label: 'Price: High to Low' }
              ].map(option => (
                <button
                  key={option.id}
                  onClick={() => setSortBy(option.id)}
                  className={`flex-1 py-2 px-2 rounded border-2 text-xs font-medium ${
                    sortBy === option.id
                      ? 'border-purple-600 bg-purple-50 text-purple-600'
                      : 'border-gray-300 bg-white text-gray-600'
                  }`}
                >
                  {option.label}
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      <div className="p-4 flex-1 overflow-auto">
        <div className="flex items-center justify-between mb-4">
          <div>
            <p className="text-sm text-gray-500">Results - {sortedProducts.length} items</p>
            <p className="text-xs text-gray-400">Updated {formatTime(lastUpdated)}</p>
          </div>
          <button 
            onClick={onRefreshPrices}
            disabled={isScraperRunning}
            className={`px-3 py-1 rounded text-sm font-medium ${
              isScraperRunning 
                ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                : 'bg-blue-600 text-white hover:bg-blue-700'
            }`}
          >
            {isScraperRunning ? (
              <span className="flex items-center gap-2">
                <RefreshCw size={14} className="animate-spin" />
                Updating...
              </span>
            ) : (
              <span className="flex items-center gap-2">
                <RefreshCw size={14} />
                Refresh
              </span>
            )}
          </button>
        </div>

        {isScraperRunning && (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <div className="flex items-center gap-2">
              <RefreshCw size={16} className="text-blue-600 animate-spin" />
              <div className="flex-1">
                <p className="text-sm font-medium text-blue-900">Scraping stores...</p>
                <p className="text-xs text-blue-700">Fetching latest prices</p>
              </div>
            </div>
          </div>
        )}

        {sortedProducts.length === 0 ? (
          <div className="text-center py-12">
            <Search size={48} className="text-gray-300 mx-auto mb-3" />
            <p className="text-gray-500">No products found</p>
            <p className="text-sm text-gray-400">Try a different search term or adjust filters</p>
          </div>
        ) : (
          <div className="space-y-4">
            {sortedProducts.map((item, i) => (
              <div 
                key={i}
                className="border-2 border-gray-200 rounded-lg p-4"
              >
                <div className="flex gap-3 mb-3" onClick={() => onViewProduct(item)}>
                  <div className="w-16 h-16 bg-gray-200 rounded flex items-center justify-center flex-shrink-0">
                    <span className="text-3xl">{item.emoji}</span>
                  </div>
                  <div className="flex-1 min-w-0">
                    <h3 className="font-medium mb-1">{item.name}</h3>
                    <p className="text-xs text-gray-500 mb-1">{item.size}</p>
                    <p className="text-xs text-gray-400">{item.perKg}</p>
                  </div>
                </div>

                <div className="border-t border-gray-200 pt-3 space-y-2">
                  <p className="text-xs font-medium text-gray-600 mb-2">Available at 2 stores:</p>
                  {item.stores.map((store, idx) => (
                    <div 
                      key={idx} 
                      className={`flex items-center justify-between p-2 rounded ${
                        idx === 0 ? 'bg-green-50' : 'bg-gray-50'
                      }`}
                    >
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium">{store.name}</span>
                        {store.badge && (
                          <span className="text-xs bg-green-600 text-white px-2 py-0.5 rounded">
                            {store.badge}
                          </span>
                        )}
                      </div>
                      <span className={`font-semibold ${
                        idx === 0 ? 'text-green-600' : 'text-gray-700'
                      }`}>
                        ${store.price.toFixed(2)}
                      </span>
                    </div>
                  ))}
                  
                  <div className="flex items-center justify-between pt-2 gap-2">
                    {item.stores.length > 1 ? (
                      <p className="text-xs text-green-600 font-medium">
                        Save ${(item.stores[1].price - item.stores[0].price).toFixed(2)} at {item.stores[0].name}
                      </p>
                    ) : (
                      <p className="text-xs text-gray-500 font-medium">
                        Only at {item.stores[0].name}
                      </p>
                    )}
                    <button 
                      onClick={(e) => {
                        e.stopPropagation();
                        onAddToBasket(item);
                      }}
                      className="bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium hover:bg-blue-700"
                    >
                      + Add
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      <NavBar active="search" onNavigate={onNavigate} basketCount={basketCount} />
    </div>
  );
}

function ProductScreen({ onNavigate, product, onAddToBasket, basketCount }) {
  if (!product) {
    return (
      <div className="flex flex-col h-full">
        <div className="bg-blue-600 text-white p-4 flex items-center gap-3">
          <button onClick={() => onNavigate('search')}>Back</button>
          <h1 className="text-lg font-semibold">Product Not Found</h1>
        </div>
        <div className="flex-1 flex items-center justify-center">
          <p className="text-gray-500">No product selected</p>
        </div>
        <NavBar active="search" onNavigate={onNavigate} basketCount={basketCount} />
      </div>
    );
  }

  const stores = [
    { store: 'Coles', price: product.colesPrice, perKg: product.perKg, badge: product.colesPrice < product.foodlandPrice ? 'Lowest' : null, inStock: true },
    { store: 'Foodland', price: product.foodlandPrice, perKg: product.perKg, badge: product.foodlandPrice < product.colesPrice ? 'Lowest' : null, inStock: true }
  ].sort((a, b) => a.price - b.price);

  return (
    <div className="flex flex-col h-full">
      <div className="bg-blue-600 text-white p-4 flex items-center gap-3">
        <button onClick={() => onNavigate('search')}>Back</button>
        <div className="flex-1">
          <h1 className="text-lg font-semibold">Coles {product.name}</h1>
          <p className="text-sm text-blue-100">{product.size}</p>
        </div>
      </div>

      <div className="p-4 flex-1 overflow-auto">
        <div className="w-full h-48 bg-gray-200 rounded-lg mb-4 flex items-center justify-center">
          <span className="text-6xl">{product.emoji}</span>
        </div>

        <div className="flex items-center gap-2 mb-4 text-sm text-gray-500">
          <Clock size={14} />
          <span>Updated 5 mins ago</span>
        </div>

        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
          <p className="text-sm font-medium text-blue-900">Fresh Produce</p>
          <p className="text-xs text-blue-700 mt-1">Price per unit: {product.perKg}</p>
          <p className="text-xs text-blue-700">Price range: ${stores[0].price.toFixed(2)} - ${stores[stores.length - 1].price.toFixed(2)}</p>
        </div>

        <h2 className="font-semibold mb-3">Available at {stores.length} stores</h2>
        
        <div className="space-y-3 mb-6">
          {stores.map((item, i) => (
            <div key={i} className={`border-2 rounded-lg p-4 ${
              i === 0 ? 'border-green-500 bg-green-50' : 'border-gray-200'
            }`}>
              <div className="flex justify-between items-center">
                <div>
                  <p className="font-medium">{item.store}</p>
                  <p className="text-sm text-gray-500">{item.inStock ? 'In stock' : 'Out of stock'}</p>
                  <p className="text-xs text-gray-400 mt-1">{item.perKg}</p>
                </div>
                <div className="text-right">
                  <p className="text-xl font-bold text-blue-600">${item.price.toFixed(2)}</p>
                  {item.badge && (
                    <span className="text-xs bg-green-600 text-white px-2 py-1 rounded mt-1 inline-block">
                      {item.badge}
                    </span>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>

        {stores.length > 1 && (
          <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
            <p className="text-sm font-medium text-green-800">
              ðŸ’° Save ${(stores[stores.length - 1].price - stores[0].price).toFixed(2)} by shopping at {stores[0].store}
            </p>
          </div>
        )}

        <button className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold" onClick={() => {
          onAddToBasket(product);
          onNavigate('basket');
        }}>
          Add to Basket
        </button>
      </div>

      <NavBar active="search" onNavigate={onNavigate} basketCount={basketCount} />
    </div>
  );
}

function BasketScreen({ onNavigate, basket, onRemoveFromBasket, onUpdateQuantity, getBasketTotal, basketCount, baskets, activeBasketId, onSelectBasket, onToggleFavorite, onRenameBasket, onClearBasket }) {
  const [showBasketSelector, setShowBasketSelector] = useState(false);
  const [isEditingName, setIsEditingName] = useState(false);
  const [editName, setEditName] = useState(basket?.name || '');

  const colesTotal = getBasketTotal('coles', basket?.id);
  const foodlandTotal = getBasketTotal('foodland', basket?.id);

  const handleSaveName = () => {
    if (editName.trim() && basket) {
      onRenameBasket(basket.id, editName.trim());
      setIsEditingName(false);
    }
  };

  if (!basket) {
    return (
      <div className="flex flex-col h-full">
        <div className="bg-blue-600 text-white p-4">
          <h1 className="text-xl font-bold">Loading...</h1>
        </div>
        <NavBar active="basket" onNavigate={onNavigate} basketCount={basketCount} />
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full">
      <div className="bg-blue-600 text-white p-4">
        <div className="flex items-center justify-between mb-2">
          <div className="flex items-center gap-2 flex-1">
            {isEditingName ? (
              <input
                type="text"
                value={editName}
                onChange={(e) => setEditName(e.target.value)}
                onBlur={handleSaveName}
                onKeyPress={(e) => e.key === 'Enter' && handleSaveName()}
                className="text-xl font-bold bg-blue-700 border-2 border-white rounded px-2 py-1 text-white"
                autoFocus
              />
            ) : (
              <>
                <button
                  onClick={() => setShowBasketSelector(!showBasketSelector)}
                  className="text-xl font-bold flex items-center gap-2"
                >
                  {basket.name}
                  <ChevronRight size={20} className={`transform transition-transform ${showBasketSelector ? 'rotate-90' : ''}`} />
                </button>
                <button
                  onClick={() => {
                    setEditName(basket.name);
                    setIsEditingName(true);
                  }}
                  className="text-blue-100 text-xs"
                >
                  âœŽ
                </button>
              </>
            )}
          </div>
          <button 
            onClick={() => onToggleFavorite(basket.id)}
            className="p-1"
          >
            <Heart 
              size={24} 
              className={basket.isFavorite ? "text-red-300 fill-red-300" : "text-white"}
            />
          </button>
        </div>
        <p className="text-sm text-blue-100">{basket.items.length} items</p>
      </div>

      {showBasketSelector && (
        <div className="bg-white border-b-2 border-gray-200 p-3">
          <p className="text-xs font-medium text-gray-500 mb-2">Switch Basket:</p>
          <div className="space-y-2">
            {baskets.map(b => (
              <button
                key={b.id}
                onClick={() => {
                  onSelectBasket(b.id);
                  setShowBasketSelector(false);
                }}
                className={`w-full text-left p-2 rounded flex items-center justify-between ${
                  b.id === activeBasketId ? 'bg-blue-50 border-2 border-blue-600' : 'bg-gray-50 border-2 border-gray-200'
                }`}
              >
                <span className="font-medium text-sm">{b.name}</span>
                <span className="text-xs text-gray-500">{b.items.length} items</span>
              </button>
            ))}
          </div>
        </div>
      )}

      <div className="p-4 flex-1 overflow-auto">
        {basket.isFavorite && basket.items.length > 0 && (
          <div className="bg-pink-50 border border-pink-200 rounded-lg p-3 mb-4 flex items-center gap-2">
            <Heart size={16} className="text-pink-600 fill-pink-600" />
            <p className="text-sm text-pink-700">This basket is saved as a favorite</p>
          </div>
        )}

        {basket.items.length > 0 && (
          <div className="mb-4">
            <button 
              onClick={() => onNavigate('compare')}
              className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2"
            >
              Compare Store Prices
              <ChevronRight size={20} />
            </button>
          </div>
        )}

        {basket.items.length === 0 ? (
          <div className="text-center py-12">
            <ShoppingCart size={48} className="text-gray-300 mx-auto mb-3" />
            <p className="text-gray-500 mb-2">Your basket is empty</p>
            <button 
              onClick={() => onNavigate('search')}
              className="text-blue-600 font-medium"
            >
              Start Shopping
            </button>
          </div>
        ) : (
          <>
            <div className="space-y-3 mb-4">
              {basket.items.map((item, i) => (
                <div key={i} className="border-2 border-gray-200 rounded-lg p-3">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xl">
                      {item.emoji}
                    </div>
                    <div className="flex-1">
                      <p className="font-medium text-sm">{item.name}</p>
                      <p className="text-xs text-gray-500">{item.size}</p>
                    </div>
                    <button 
                      onClick={() => onRemoveFromBasket(item.name)}
                      className="text-red-500 hover:text-red-700"
                    >
                      âœ•
                    </button>
                  </div>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={() => onUpdateQuantity(item.name, item.quantity - 1)}
                        className="w-8 h-8 bg-gray-200 rounded flex items-center justify-center font-bold"
                      >
                        âˆ’
                      </button>
                      <span className="w-8 text-center font-medium">{item.quantity}</span>
                      <button 
                        onClick={() => onUpdateQuantity(item.name, item.quantity + 1)}
                        className="w-8 h-8 bg-gray-200 rounded flex items-center justify-center font-bold"
                      >
                        +
                      </button>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold">${(item.colesPrice * item.quantity).toFixed(2)}</p>
                      <p className="text-xs text-gray-500">Coles price</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
              <div className="flex justify-between items-center mb-2">
                <span className="font-semibold">Coles Total</span>
                <span className="text-xl font-bold text-blue-600">${colesTotal.toFixed(2)}</span>
              </div>
              <div className="flex justify-between items-center text-sm text-gray-600">
                <span>Foodland Total</span>
                <span>${foodlandTotal.toFixed(2)}</span>
              </div>
              {colesTotal < foodlandTotal && (
                <p className="text-xs text-green-600 mt-2">
                  ðŸ’° Save ${(foodlandTotal - colesTotal).toFixed(2)} at Coles!
                </p>
              )}
              {foodlandTotal < colesTotal && (
                <p className="text-xs text-green-600 mt-2">
                  ðŸ’° Save ${(colesTotal - foodlandTotal).toFixed(2)} at Foodland!
                </p>
              )}
            </div>
          </>
        )}

        <button 
          onClick={() => onNavigate('search')}
          className="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 flex items-center justify-center gap-2 text-gray-500"
        >
          <Plus size={20} />
          Add More Items
        </button>
      </div>

      <NavBar active="basket" onNavigate={onNavigate} basketCount={basketCount} />
    </div>
  );
}

function CompareScreen({ onNavigate, basket, getBasketTotal, basketCount }) {
  if (!basket) {
    return (
      <div className="flex flex-col h-full">
        <div className="bg-blue-600 text-white p-4 flex items-center gap-3">
          <button onClick={() => onNavigate('basket')}>Back</button>
          <h1 className="text-lg font-semibold">Compare Stores</h1>
        </div>
        <div className="p-4 flex-1 overflow-auto">
          <div className="text-center py-12">
            <ShoppingCart size={48} className="text-gray-300 mx-auto mb-3" />
            <p className="text-gray-500 mb-2">Loading basket...</p>
          </div>
        </div>
        <NavBar active="basket" onNavigate={onNavigate} basketCount={basketCount} />
      </div>
    );
  }

  const colesTotal = getBasketTotal('coles', basket.id);
  const foodlandTotal = getBasketTotal('foodland', basket.id);
  const savings = Math.abs(colesTotal - foodlandTotal);
  const cheaperStore = colesTotal < foodlandTotal ? 'Coles' : 'Foodland';

  const stores = [
    { 
      store: 'Coles', 
      total: colesTotal, 
      savings: colesTotal < foodlandTotal ? 'Best Price' : `$${savings.toFixed(2)} more`, 
      items: `${basket.items.length}/${basket.items.length}`, 
      badge: colesTotal < foodlandTotal ? 'Best Value' : null 
    },
    { 
      store: 'Foodland', 
      total: foodlandTotal, 
      savings: foodlandTotal < colesTotal ? 'Best Price' : `$${savings.toFixed(2)} more`, 
      items: `${basket.items.length}/${basket.items.length}`, 
      badge: foodlandTotal < colesTotal ? 'Best Value' : null 
    }
  ];

  return (
    <div className="flex flex-col h-full">
      <div className="bg-blue-600 text-white p-4 flex items-center gap-3">
        <button onClick={() => onNavigate('basket')}>Back</button>
        <h1 className="text-lg font-semibold">Compare Stores</h1>
      </div>

      <div className="p-4 flex-1 overflow-auto">
        {basket.items.length === 0 ? (
          <div className="text-center py-12">
            <ShoppingCart size={48} className="text-gray-300 mx-auto mb-3" />
            <p className="text-gray-500 mb-2">Add items to your basket to compare prices</p>
            <button 
              onClick={() => onNavigate('search')}
              className="text-blue-600 font-medium"
            >
              Start Shopping
            </button>
          </div>
        ) : (
          <>
            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
              <p className="text-sm text-gray-600 mb-2">Your Basket ({basket.items.length} items)</p>
              <p className="text-2xl font-bold text-blue-600">${Math.min(colesTotal, foodlandTotal).toFixed(2)} - ${Math.max(colesTotal, foodlandTotal).toFixed(2)}</p>
              <p className="text-xs text-gray-500 mt-1">Save up to ${savings.toFixed(2)} by shopping at {cheaperStore}</p>
            </div>

            <h2 className="font-semibold mb-3">Store Comparison</h2>
            
            <div className="space-y-3">
              {stores.map((item, i) => (
                <div key={i} className={`border-2 rounded-lg p-4 ${item.badge ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <h3 className="font-bold text-lg">{item.store}</h3>
                      {item.badge && (
                        <span className="text-xs bg-green-600 text-white px-2 py-1 rounded mt-1 inline-block">
                          {item.badge}
                        </span>
                      )}
                    </div>
                    <div className="text-right">
                      <p className="text-2xl font-bold">${item.total.toFixed(2)}</p>
                      <p className="text-xs text-green-600">{item.savings}</p>
                    </div>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">{item.items} available</span>
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-4 p-3 bg-gray-50 rounded-lg">
              <p className="text-xs text-gray-600">
                All items available at both stores. {cheaperStore} offers the best total price!
              </p>
            </div>
          </>
        )}
      </div>

      <NavBar active="basket" onNavigate={onNavigate} basketCount={basketCount} />
    </div>
  );
}

function SettingsScreen({ onNavigate, basketCount }) {
  return (
    <div className="flex flex-col h-full">
      <div className="bg-blue-600 text-white p-4">
        <h1 className="text-xl font-bold">Settings</h1>
      </div>

      <div className="p-4 flex-1 overflow-auto">
        <h2 className="font-semibold text-lg mb-3">Account</h2>
        <div className="space-y-3 mb-6">
          <button className="w-full text-left p-4 border-2 border-gray-200 rounded-lg">
            Profile Information
          </button>
          <button className="w-full text-left p-4 border-2 border-gray-200 rounded-lg">
            Notifications
          </button>
        </div>

        <h2 className="font-semibold text-lg mb-3">Admin</h2>
        <div className="space-y-3">
          <button 
            onClick={() => onNavigate('scraper')}
            className="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-blue-400 flex items-center justify-between"
          >
            <div className="flex items-center gap-3">
              <Database size={20} className="text-blue-600" />
              <span>Scraper Dashboard</span>
            </div>
            <ChevronRight size={18} className="text-gray-400" />
          </button>
        </div>
      </div>

      <NavBar active="settings" onNavigate={onNavigate} basketCount={basketCount} />
    </div>
  );
}

function ScraperDashboard({ onNavigate, isScraperRunning, lastUpdated, lastFoodlandUpdate, onRefreshPrices, products, basketCount }) {
  const formatTimeSince = (date) => {
    const now = new Date();
    const hours = Math.floor((now - date) / (1000 * 60 * 60));
    const minutes = Math.floor((now - date) / (1000 * 60)) % 60;
    
    if (hours >= 24) {
      const days = Math.floor(hours / 24);
      return `${days} day${days > 1 ? 's' : ''} ago`;
    }
    if (hours > 0) {
      return `${hours}h ${minutes}m ago`;
    }
    return `${minutes}m ago`;
  };

  const nextFoodlandRun = new Date(lastFoodlandUpdate);
  nextFoodlandRun.setDate(nextFoodlandRun.getDate() + 1);
  nextFoodlandRun.setHours(2, 0, 0, 0);

  return (
    <div className="flex flex-col h-full">
      <div className="bg-red-600 text-white p-4 flex items-center gap-3">
        <button onClick={() => onNavigate('settings')}>Back</button>
        <h1 className="text-lg font-semibold">Scraper Dashboard</h1>
      </div>

      <div className="p-4 flex-1 overflow-auto">
        <div className="bg-red-50 border-2 border-red-200 rounded-lg p-3 mb-4 flex items-center gap-2">
          <AlertCircle size={18} className="text-red-600" />
          <p className="text-sm text-red-700">Admin access only - not visible to users</p>
        </div>

        <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
          <div className="flex items-center gap-2 mb-2">
            <RefreshCw size={18} className="text-blue-600" />
            <h3 className="font-semibold">Live Mock Scrapers</h3>
          </div>
          <p className="text-sm text-gray-700 mb-2">
            Coles: Manual updates | Foodland: Auto-updates daily
          </p>
          <p className="text-xs text-gray-600">
            In production, these would connect to your backend scraper APIs.
          </p>
        </div>

        <h2 className="font-semibold mb-3">Scraper Status</h2>
        
        <div className="border-2 border-gray-200 rounded-lg p-4 mb-3">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-3">
              {!isScraperRunning ? (
                <CheckCircle size={20} className="text-green-600" />
              ) : (
                <RefreshCw size={20} className="text-blue-600 animate-spin" />
              )}
              <div>
                <h3 className="font-bold">Coles</h3>
                <p className="text-xs text-gray-500">On-demand</p>
              </div>
            </div>
            <span className={`text-xs px-2 py-1 rounded ${
              isScraperRunning 
                ? 'bg-blue-100 text-blue-700' 
                : 'bg-green-100 text-green-700'
            }`}>
              {isScraperRunning ? 'Running' : 'Active'}
            </span>
          </div>
          
          <div className="grid grid-cols-2 gap-3 text-sm mb-3">
            <div>
              <p className="text-gray-500">Last Updated</p>
              <p className="font-medium">{formatTimeSince(lastUpdated)}</p>
            </div>
            <div>
              <p className="text-gray-500">Products</p>
              <p className="font-medium">{products.length}</p>
            </div>
          </div>
        </div>

        <div className="border-2 border-purple-200 rounded-lg p-4 mb-4 bg-purple-50">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-3">
              <CheckCircle size={20} className="text-purple-600" />
              <div>
                <h3 className="font-bold">Foodland</h3>
                <p className="text-xs text-purple-600 font-medium">Daily at 2:00 AM</p>
              </div>
            </div>
            <span className="text-xs px-2 py-1 rounded bg-purple-200 text-purple-700">
              Auto-Daily
            </span>
          </div>
          
          <div className="grid grid-cols-2 gap-3 text-sm mb-3">
            <div>
              <p className="text-gray-500">Last Updated</p>
              <p className="font-medium">{formatTimeSince(lastFoodlandUpdate)}</p>
            </div>
            <div>
              <p className="text-gray-500">Products</p>
              <p className="font-medium">{products.length}</p>
            </div>
          </div>

          <div className="mt-3 p-2 bg-purple-100 rounded text-xs text-purple-800">
            <p className="font-medium">Next scheduled run:</p>
            <p>{nextFoodlandRun.toLocaleString()}</p>
          </div>
        </div>

        <button 
          onClick={() => onRefreshPrices('both')}
          disabled={isScraperRunning}
          className={`w-full py-3 rounded-lg font-semibold flex items-center justify-center gap-2 ${
            isScraperRunning 
              ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
              : 'bg-blue-600 text-white hover:bg-blue-700'
          }`}
        >
          <RefreshCw size={18} className={isScraperRunning ? 'animate-spin' : ''} />
          {isScraperRunning ? 'Scraping...' : 'Run Manual Scrape (Both Stores)'}
        </button>

        <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p className="text-xs text-yellow-800 font-medium mb-1">Demo Mode</p>
          <p className="text-xs text-yellow-700">
            Foodland scraper is set to auto-run daily at 2:00 AM. In production, this would be a real cron job.
          </p>
        </div>
      </div>

      <NavBar active="settings" onNavigate={onNavigate} basketCount={basketCount} />
    </div>
  );
}

const parseData = () => {
  // ALL 30 Coles products - compressed format: name|price|perKg|size
  const colesStr = `Bananas|0.45|$2.50/1kg|approx. 180g
Strawberries|3.50|$14.00/1kg|250g
Hass Avocados|2.00|$2.00/1ea|1 Each
Seedless Watermelon Cut|4.50|$2.50/1kg|approx. 1.8kg
Broccoli Medium|2.01|$5.90/1kg|approx. 340g
Red Capsicum Loose|2.18|$9.90/1kg|approx. 220g
Cucumbers Continental Loose|1.90|$1.90/1ea|1 Each
Green Kiwifruit|1.90|$1.90/1ea|1 Each
Baby Spinach|3.00|$25.00/1kg|120g
White Seedless Grapes|5.00|$5.00/1kg|approx. 1kg
Raspberries|4.50|$36.00/1kg|125g
Pink Lady Apples|7.90|$7.90/1kg|1kg
4 Leaf Salad Mix|3.00|$15.00/1kg|200g
Iceberg Lettuce|2.50|$2.50/1ea|1 Each
Baby Cucumbers|3.00|$12.00/1kg|250g
Carrots|2.50|$2.50/1kg|1Kg
Green Zucchini|0.78|$3.90/1kg|approx. 200g
Bananas Mini Pack|2.50|$3.33/1kg|750g
Premium Strawberries|6.00|$17.14/1kg|350g
White Nectarines|0.49|$3.30/1kg|approx. 150g
Wrapped Butternut Pumpkin|2.45|$3.50/1kg|approx. 700g
Red Seedless Grapes|5.50|$5.50/1kg|approx. 1kg
Apple Granny Smith Medium|1.00|$5.90/1kg|approx. 170g
Sliced Mushrooms|4.00|$20.00/1kg|200g
Rockmelon Whole|3.50|$3.50/1ea|1 Each
Oranges Prepacked|8.90|$2.97/1kg|3kg
Cauliflower Medium|5.00|$5.00/1ea|1 Each
Celery Bunch|4.00|$4.00/1ea|1 Each
Royal Gala Apples Loose|1.34|$7.90/1kg|approx. 170g
Topless Pineapple|3.90|$3.90/1ea|1 each
Yellow Capsicum|2.84|$12.90/1kg|approx. 220g
Granny Smith Apples|5.90|$5.90/1kg|1kg`;

  // ALL matched Foodland products - name|price
  const foodlandStr = `Bananas|0.90
Strawberry Punnet|4.99
Avocados|2.30
Seedless Watermelon|17.43
Broccoli|1.70
Red Capsicum|1.08
Continental Cucumber|1.80
Green Kiwi Fruit|2.20
Spinach|3.59
Grapes|4.17
Raspberry Punnet|7.90
Pink Lady Apples|6.99
Iceberg Lettuce|3.49
Baby Cucumbers|2.99
Carrots|2.20
Zucchini|0.98
White Nectarines|1.00
Butternut Pumpkin|4.90
Red Grapes|3.43
Granny Smith Apples|6.90
Mushrooms|5.99
Rockmelon|8.97
Oranges|7.99
Cauliflower|4.99
Celery|3.90
Royal Gala Apples|7.90
Pineapple|6.50
Yellow Capsicum|3.28`;

  const emojiMap = {
    'banana': 'ðŸŒ', 'strawberr': 'ðŸ“', 'avocado': 'ðŸ¥‘', 'watermelon': 'ðŸ‰',
    'broccol': 'ðŸ¥¦', 'capsicum': 'ðŸ«‘', 'cucumber': 'ðŸ¥’', 'kiwi': 'ðŸ¥',
    'spinach': 'ðŸ¥¬', 'grape': 'ðŸ‡', 'raspberr': 'ðŸ«', 'lettuce': 'ðŸ¥¬',
    'carrot': 'ðŸ¥•', 'zucchini': 'ðŸ¥’', 'nectarine': 'ðŸ‘', 'pumpkin': 'ðŸŽƒ',
    'mushroom': 'ðŸ„', 'rockmelon': 'ðŸˆ', 'orange': 'ðŸŠ', 'cauliflower': 'ðŸ¥¦',
    'celery': 'ðŸ¥¬', 'apple': 'ðŸŽ', 'pineapple': 'ðŸ', 'salad': 'ðŸ¥—'
  };

  // Parse Foodland into map
  const foodlandMap = {};
  foodlandStr.split('\n').forEach(line => {
    const [name, price] = line.split('|');
    const key = name.toLowerCase().replace(/[^a-z]/g, '');
    foodlandMap[key] = parseFloat(price);
  });

  // Parse Coles and match with Foodland
  const products = [];
  colesStr.split('\n').forEach(line => {
    const [name, price, perKg, size] = line.split('|');
    const colesPrice = parseFloat(price);
    
    // Match with Foodland
    const key = name.toLowerCase().replace(/[^a-z]/g, '');
    const foodlandPrice = foodlandMap[key] || colesPrice * 1.10;
    
    // Find emoji
    let emoji = 'ðŸ›’';
    for (const [k, v] of Object.entries(emojiMap)) {
      if (key.includes(k)) {
        emoji = v;
        break;
      }
    }
    
    products.push({
      name: name,
      size: size,
      colesPrice: colesPrice,
      foodlandPrice: foodlandPrice,
      perKg: perKg,
      emoji: emoji
    });
  });
  
  return products;
};

function PriceCompareApp() {
  const [currentScreen, setCurrentScreen] = useState('home');
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [isScraperRunning, setIsScraperRunning] = useState(false);
  const [lastUpdated, setLastUpdated] = useState(new Date());
  const [lastFoodlandUpdate, setLastFoodlandUpdate] = useState(new Date(Date.now() - 3600000));
  const [baskets, setBaskets] = useState([
    { id: 1, name: 'Weekly Shop', items: [], isFavorite: false },
    { id: 2, name: 'Quick Essentials', items: [], isFavorite: false },
    { id: 3, name: 'Meal Prep', items: [], isFavorite: false }
  ]);
  const [activeBasketId, setActiveBasketId] = useState(1);

  const [products, setProducts] = useState(parseData());

  const activeBasket = baskets.find(b => b.id === activeBasketId) || baskets[0];

  const addToBasket = (product, quantity = 1, basketId = activeBasketId) => {
    setBaskets(prev => prev.map(basket => {
      if (basket.id !== basketId) return basket;
      
      const existing = basket.items.find(item => item.name === product.name);
      if (existing) {
        return {
          ...basket,
          items: basket.items.map(item => 
            item.name === product.name 
              ? { ...item, quantity: item.quantity + quantity }
              : item
          )
        };
      }
      return {
        ...basket,
        items: [...basket.items, { ...product, quantity }]
      };
    }));
  };

  const removeFromBasket = (productName, basketId = activeBasketId) => {
    setBaskets(prev => prev.map(basket => {
      if (basket.id !== basketId) return basket;
      return {
        ...basket,
        items: basket.items.filter(item => item.name !== productName)
      };
    }));
  };

  const updateQuantity = (productName, quantity, basketId = activeBasketId) => {
    if (quantity <= 0) {
      removeFromBasket(productName, basketId);
    } else {
      setBaskets(prev => prev.map(basket => {
        if (basket.id !== basketId) return basket;
        return {
          ...basket,
          items: basket.items.map(item =>
            item.name === productName ? { ...item, quantity } : item
          )
        };
      }));
    }
  };

  const toggleBasketFavorite = (basketId) => {
    setBaskets(prev => prev.map(basket => 
      basket.id === basketId ? { ...basket, isFavorite: !basket.isFavorite } : basket
    ));
  };

  const renameBasket = (basketId, newName) => {
    setBaskets(prev => prev.map(basket => 
      basket.id === basketId ? { ...basket, name: newName } : basket
    ));
  };

  const clearBasket = (basketId) => {
    setBaskets(prev => prev.map(basket => 
      basket.id === basketId ? { ...basket, items: [] } : basket
    ));
  };

  const getBasketTotal = (store, basketId = activeBasketId) => {
    const basket = baskets.find(b => b.id === basketId);
    if (!basket) return 0;
    
    return basket.items.reduce((total, item) => {
      const price = store === 'coles' ? item.colesPrice : item.foodlandPrice;
      return total + (price * item.quantity);
    }, 0);
  };

  const runMockScraper = (store = 'both') => {
    setIsScraperRunning(true);
    
    setTimeout(() => {
      setProducts(prev => prev.map(product => ({
        ...product,
        colesPrice: parseFloat((product.colesPrice + (Math.random() - 0.5) * 0.2).toFixed(2)),
        foodlandPrice: parseFloat((product.foodlandPrice + (Math.random() - 0.5) * 0.2).toFixed(2))
      })));
      
      setLastUpdated(new Date());
      if (store === 'foodland' || store === 'both') {
        setLastFoodlandUpdate(new Date());
      }
      setIsScraperRunning(false);
    }, 3000);
  };

  useEffect(() => {
    const checkDailyScraper = () => {
      const now = new Date();
      const hoursSinceLastUpdate = (now - lastFoodlandUpdate) / (1000 * 60 * 60);
      
      if (hoursSinceLastUpdate >= 24 && !isScraperRunning) {
        runMockScraper('foodland');
      }
    };

    const interval = setInterval(checkDailyScraper, 60000);
    return () => clearInterval(interval);
  }, [lastFoodlandUpdate, isScraperRunning]);

  const handleViewProduct = (product) => {
    setSelectedProduct(product);
    setCurrentScreen('product');
  };

  const handleNavigate = (screen) => {
    setCurrentScreen(screen);
    if (screen === 'search') {
      setSearchQuery('');
    }
  };

  const renderScreen = () => {
    const screenProps = {
      onNavigate: handleNavigate,
      products,
      isScraperRunning,
      lastUpdated,
      lastFoodlandUpdate,
      onRefreshPrices: runMockScraper,
      onViewProduct: handleViewProduct,
      searchQuery,
      setSearchQuery,
      basket: activeBasket,
      baskets,
      activeBasketId,
      basketCount: activeBasket.items.length,
      onAddToBasket: addToBasket,
      onRemoveFromBasket: removeFromBasket,
      onUpdateQuantity: updateQuantity,
      getBasketTotal,
      onSelectBasket: setActiveBasketId,
      onToggleFavorite: toggleBasketFavorite,
      onRenameBasket: renameBasket,
      onClearBasket: clearBasket
    };

    switch(currentScreen) {
      case 'home': return <HomeScreen {...screenProps} />;
      case 'search': return <SearchScreen {...screenProps} />;
      case 'product': return <ProductScreen {...screenProps} product={selectedProduct} />;
      case 'basket': return <BasketScreen {...screenProps} />;
      case 'compare': return <CompareScreen {...screenProps} />;
      case 'settings': return <SettingsScreen {...screenProps} />;
      case 'scraper': return <ScraperDashboard {...screenProps} />;
      default: return <HomeScreen {...screenProps} />;
    }
  };

  return (
    <div className="w-full h-screen bg-gray-100 flex items-center justify-center p-4">
      <div className="w-full max-w-md h-full max-h-[800px] bg-white rounded-lg shadow-2xl overflow-hidden">
        {renderScreen()}
      </div>
    </div>
  );
}

    // Mount the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PriceCompareApp />);
    
    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registered:', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed:', err);
          });
      });
    }
  </script>
</body>
</html>
